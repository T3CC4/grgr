<!-- dashboard/views/support.ejs - Complete Ticket System View -->
<%- include('partials/header', { title: 'Support - Omnia Bot' }) %>
<%- include('partials/navbar', { user: user, activeTab: 'support' }) %>

<div class="container-fluid mt-4">
    <% if (isStaff) { %>
        <!-- Staff View -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>Support Tickets</h1>
                        <span class="badge bg-<%= roleColor %>"><%= role %></span>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTicketModal">
                        <i class="bi bi-plus-circle"></i> Create Ticket
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <% if (stats) { %>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary"><%= stats.total %></h3>
                            <p class="text-muted mb-0">Total Tickets</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success"><%= stats.open %></h3>
                            <p class="text-muted mb-0">Open</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning"><%= stats.in_progress %></h3>
                            <p class="text-muted mb-0">In Progress</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-secondary"><%= stats.closed %></h3>
                            <p class="text-muted mb-0">Closed</p>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
        
        <!-- Tabs for different views -->
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#allTickets">All Tickets</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#myTickets">My Tickets</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#openTickets">Open</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#inProgressTickets">In Progress</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#closedTickets">Closed</a>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- All Tickets -->
            <div class="tab-pane fade show active" id="allTickets">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Assigned To</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% allTickets.forEach(ticket => { %>
                                        <tr>
                                            <td><code><%= ticket.ticket_id %></code></td>
                                            <td><%= ticket.username %></td>
                                            <td><%= ticket.subject %></td>
                                            <td><span class="badge bg-secondary"><%= ticket.category %></span></td>
                                            <td>
                                                <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                    <%= ticket.status.replace('_', ' ') %>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-<%= ticket.priority === 'high' ? 'danger' : ticket.priority === 'normal' ? 'primary' : 'secondary' %>">
                                                    <%= ticket.priority %>
                                                </span>
                                            </td>
                                            <td><%= ticket.assigned_to || 'Unassigned' %></td>
                                            <td><%= new Date(ticket.created_at).toLocaleDateString() %></td>
                                            <td>
                                                <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Tickets -->
            <div class="tab-pane fade" id="myTickets">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>Subject</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% userTickets.forEach(ticket => { %>
                                        <tr>
                                            <td><code><%= ticket.ticket_id %></code></td>
                                            <td><%= ticket.subject %></td>
                                            <td><span class="badge bg-secondary"><%= ticket.category %></span></td>
                                            <td>
                                                <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                    <%= ticket.status.replace('_', ' ') %>
                                                </span>
                                            </td>
                                            <td><%= new Date(ticket.created_at).toLocaleDateString() %></td>
                                            <td>
                                                <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Open Tickets -->
            <div class="tab-pane fade" id="openTickets">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Priority</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% allTickets.filter(t => t.status === 'open').forEach(ticket => { %>
                                        <tr>
                                            <td><code><%= ticket.ticket_id %></code></td>
                                            <td><%= ticket.username %></td>
                                            <td><%= ticket.subject %></td>
                                            <td>
                                                <span class="badge bg-<%= ticket.priority === 'high' ? 'danger' : ticket.priority === 'normal' ? 'primary' : 'secondary' %>">
                                                    <%= ticket.priority %>
                                                </span>
                                            </td>
                                            <td><%= new Date(ticket.created_at).toLocaleDateString() %></td>
                                            <td>
                                                <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- In Progress -->
            <div class="tab-pane fade" id="inProgressTickets">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Assigned To</th>
                                        <th>Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% allTickets.filter(t => t.status === 'in_progress').forEach(ticket => { %>
                                        <tr>
                                            <td><code><%= ticket.ticket_id %></code></td>
                                            <td><%= ticket.username %></td>
                                            <td><%= ticket.subject %></td>
                                            <td><%= ticket.assigned_to || 'Unassigned' %></td>
                                            <td><%= new Date(ticket.updated_at).toLocaleDateString() %></td>
                                            <td>
                                                <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Closed -->
            <div class="tab-pane fade" id="closedTickets">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ticket ID</th>
                                        <th>User</th>
                                        <th>Subject</th>
                                        <th>Closed By</th>
                                        <th>Closed At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% allTickets.filter(t => t.status === 'closed').forEach(ticket => { %>
                                        <tr>
                                            <td><code><%= ticket.ticket_id %></code></td>
                                            <td><%= ticket.username %></td>
                                            <td><%= ticket.subject %></td>
                                            <td><%= ticket.closed_by || 'System' %></td>
                                            <td><%= ticket.closed_at ? new Date(ticket.closed_at).toLocaleDateString() : '-' %></td>
                                            <td>
                                                <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-secondary">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    <% } else { %>
        <!-- Regular User View -->
        <div class="row">
            <div class="col-md-8">
                <h1>Support Center</h1>
                <p class="lead">Need help? Create a support ticket and our team will assist you.</p>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Your Tickets</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTicketModal">
                            <i class="bi bi-plus-circle"></i> New Ticket
                        </button>
                    </div>
                    <div class="card-body">
                        <% if (userTickets.length === 0) { %>
                            <p class="text-muted text-center py-4">You haven't created any tickets yet.</p>
                        <% } else { %>
                            <div class="list-group">
                                <% userTickets.forEach(ticket => { %>
                                    <a href="/support/ticket/<%= ticket.ticket_id %>" class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1"><%= ticket.subject %></h6>
                                                <p class="mb-1 text-muted"><%= ticket.ticket_id %></p>
                                                <small class="text-muted">Created <%= new Date(ticket.created_at).toLocaleDateString() %></small>
                                            </div>
                                            <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                <%= ticket.status.replace('_', ' ') %>
                                            </span>
                                        </div>
                                    </a>
                                <% }) %>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5><i class="bi bi-info-circle"></i> How It Works</h5>
                        <ol>
                            <li>Create a ticket describing your issue</li>
                            <li>Our support team will review it</li>
                            <li>You'll receive a response within 24 hours</li>
                            <li>Continue the conversation in the ticket</li>
                        </ol>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-body">
                        <h5><i class="bi bi-clock"></i> Response Times</h5>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-danger">High Priority</span> 1-2 hours</li>
                            <li><span class="badge bg-primary">Normal</span> 12-24 hours</li>
                            <li><span class="badge bg-secondary">Low</span> 24-48 hours</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    <% } %>
</div>

<!-- Create Ticket Modal -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Support Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTicketForm">
                    <div class="mb-3">
                        <label for="ticketCategory" class="form-label">Category</label>
                        <select class="form-select" id="ticketCategory" required>
                            <option value="">Select a category...</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="billing">Billing Issue</option>
                            <option value="technical">Technical Support</option>
                            <option value="general">General Question</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ticketSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="ticketSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="ticketMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="ticketMessage" rows="5" required></textarea>
                        <div class="form-text">Please describe your issue in detail</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTicket()">Create Ticket</button>
            </div>
        </div>
    </div>
</div>

<script>
async function createTicket() {
    const category = document.getElementById('ticketCategory').value;
    const subject = document.getElementById('ticketSubject').value;
    const message = document.getElementById('ticketMessage').value;
    
    if (!category || !subject || !message) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const response = await fetch('/support/ticket/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                category: category,
                subject: subject,
                message: message
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = '/support/ticket/' + result.ticketId;
        } else {
            alert('Error creating ticket: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating ticket');
    }
}
</script>

<%- include('partials/footer') %>