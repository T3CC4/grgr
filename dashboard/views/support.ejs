<!-- dashboard/views/support.ejs - COMPLETE UNIFIED VERSION -->
<%- include('partials/header', { title: 'Support - Omnia Bot' }) %>
<%- include('partials/navbar', { user: user, activeTab: 'support' }) %>

<div class="container-fluid mt-4">
    <% if (typeof ticket !== 'undefined' && ticket) { %>
        <!-- Single Ticket View -->
        <div class="row">
            <div class="col-md-8">
                <!-- Ticket Header -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <a href="/support" class="text-decoration-none">
                                        <i class="bi bi-arrow-left"></i>
                                    </a>
                                    <%= ticket.subject %>
                                </h5>
                                <small class="text-muted">
                                    Ticket ID: <code><%= ticket.ticket_id %></code> | 
                                    Created by <%= ticket.username %> on <%= new Date(ticket.created_at).toLocaleString() %>
                                </small>
                            </div>
                            <div>
                                <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                    <%= ticket.status.replace('_', ' ').toUpperCase() %>
                                </span>
                                <span class="badge bg-<%= ticket.priority === 'high' ? 'danger' : ticket.priority === 'normal' ? 'primary' : 'secondary' %>">
                                    <%= ticket.priority.toUpperCase() %>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Conversation</h6>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="messageContainer">
                        <% ticket.messages.forEach((message) => { %>
                            <div class="<%= message.is_staff ? 'text-end' : '' %> mb-3">
                                <div class="d-inline-block <%= message.is_staff ? 'bg-primary text-white' : 'bg-light' %> p-3 rounded" style="max-width: 70%;">
                                    <div class="mb-2">
                                        <strong>
                                            <%= message.username %>
                                            <% if (message.is_staff) { %>
                                                <span class="badge bg-warning text-dark ms-1">Staff</span>
                                            <% } %>
                                        </strong>
                                        <small class="<%= message.is_staff ? 'text-white-50' : 'text-muted' %> ms-2">
                                            <%= new Date(message.created_at).toLocaleString() %>
                                        </small>
                                    </div>
                                    <div style="white-space: pre-wrap;"><%= message.message %></div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Reply Form -->
                    <% if (ticket.status !== 'closed') { %>
                        <div class="card-footer">
                            <form id="replyForm">
                                <div class="input-group">
                                    <textarea class="form-control" id="replyMessage" rows="2" placeholder="Type your message..." required></textarea>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-send"></i> Send
                                    </button>
                                </div>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="card-footer">
                            <p class="text-muted text-center mb-0">
                                <i class="bi bi-lock"></i> This ticket is closed
                            </p>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Ticket Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Ticket Information</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                    <%= ticket.status.replace('_', ' ') %>
                                </span>
                            </dd>
                            
                            <dt class="col-sm-4">Priority:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-<%= ticket.priority === 'high' ? 'danger' : ticket.priority === 'normal' ? 'primary' : 'secondary' %>">
                                    <%= ticket.priority %>
                                </span>
                            </dd>
                            
                            <dt class="col-sm-4">Category:</dt>
                            <dd class="col-sm-8"><%= ticket.category %></dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8"><%= new Date(ticket.created_at).toLocaleDateString() %></dd>
                            
                            <dt class="col-sm-4">Updated:</dt>
                            <dd class="col-sm-8"><%= new Date(ticket.updated_at).toLocaleDateString() %></dd>
                            
                            <% if (ticket.assigned_to) { %>
                                <dt class="col-sm-4">Assigned:</dt>
                                <dd class="col-sm-8"><%= ticket.assigned_to %></dd>
                            <% } %>
                            
                            <% if (ticket.closed_at) { %>
                                <dt class="col-sm-4">Closed:</dt>
                                <dd class="col-sm-8"><%= new Date(ticket.closed_at).toLocaleDateString() %></dd>
                            <% } %>
                        </dl>
                    </div>
                </div>
                
                <!-- Staff Actions -->
                <% if (isStaff && canManage) { %>
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="bi bi-shield-lock"></i> Staff Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Status Change -->
                            <div class="mb-3">
                                <label class="form-label">Change Status</label>
                                <select class="form-select" id="statusSelect" onchange="support.updateStatus(this.value)">
                                    <option value="open" <%= ticket.status === 'open' ? 'selected' : '' %>>Open</option>
                                    <option value="in_progress" <%= ticket.status === 'in_progress' ? 'selected' : '' %>>In Progress</option>
                                    <option value="closed" <%= ticket.status === 'closed' ? 'selected' : '' %>>Closed</option>
                                </select>
                            </div>
                            
                            <!-- Priority Change -->
                            <div class="mb-3">
                                <label class="form-label">Change Priority</label>
                                <select class="form-select" id="prioritySelect" onchange="support.updatePriority(this.value)">
                                    <option value="low" <%= ticket.priority === 'low' ? 'selected' : '' %>>Low</option>
                                    <option value="normal" <%= ticket.priority === 'normal' ? 'selected' : '' %>>Normal</option>
                                    <option value="high" <%= ticket.priority === 'high' ? 'selected' : '' %>>High</option>
                                </select>
                            </div>
                            
                            <!-- Assign Ticket -->
                            <div class="mb-3">
                                <label class="form-label">Assign To</label>
                                <select class="form-select" id="assignSelect" onchange="support.assignTicket(this.value)">
                                    <option value="">Unassigned</option>
                                    <option value="<%= user.id %>" <%= ticket.assigned_to === user.id ? 'selected' : '' %>>Me</option>
                                </select>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="d-grid gap-2">
                                <% if (ticket.status !== 'closed') { %>
                                    <button class="btn btn-danger btn-sm" onclick="support.updateStatus('closed')">
                                        <i class="bi bi-x-circle"></i> Close Ticket
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-success btn-sm" onclick="support.updateStatus('open')">
                                        <i class="bi bi-arrow-clockwise"></i> Reopen Ticket
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <!-- User Actions -->
                <% if (!isStaff && ticket.user_id === user.id && ticket.status !== 'closed') { %>
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Actions</h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-secondary btn-sm w-100" onclick="if(confirm('Are you sure you want to close this ticket?')) support.updateStatus('closed')">
                                <i class="bi bi-x-circle"></i> Close Ticket
                            </button>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
        
    <% } else { %>
        <!-- Support Dashboard -->
        <% if (isStaff) { %>
            <!-- Staff View -->
            <div class="row mb-4">
                <div class="col">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1>Support Tickets</h1>
                            <span class="badge bg-<%= roleColor %>"><%= role %></span>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTicketModal">
                            <i class="bi bi-plus-circle"></i> Create Ticket
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Statistics -->
            <% if (stats) { %>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary"><%= stats.total %></h3>
                                <p class="text-muted mb-0">Total Tickets</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success"><%= stats.open %></h3>
                                <p class="text-muted mb-0">Open</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning"><%= stats.in_progress %></h3>
                                <p class="text-muted mb-0">In Progress</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-secondary"><%= stats.closed %></h3>
                                <p class="text-muted mb-0">Closed</p>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <!-- Tabs for different views -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#allTickets">All Tickets</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#myTickets">My Tickets</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#openTickets">Open</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#inProgressTickets">In Progress</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#closedTickets">Closed</a>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- All Tickets -->
                <div class="tab-pane fade show active" id="allTickets">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Ticket ID</th>
                                            <th>User</th>
                                            <th>Subject</th>
                                            <th>Category</th>
                                            <th>Status</th>
                                            <th>Priority</th>
                                            <th>Assigned To</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% allTickets.forEach(ticket => { %>
                                            <tr>
                                                <td><code><%= ticket.ticket_id %></code></td>
                                                <td><%= ticket.username %></td>
                                                <td><%= ticket.subject %></td>
                                                <td><span class="badge bg-secondary"><%= ticket.category %></span></td>
                                                <td>
                                                    <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                        <%= ticket.status.replace('_', ' ') %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-<%= ticket.priority === 'high' ? 'danger' : ticket.priority === 'normal' ? 'primary' : 'secondary' %>">
                                                        <%= ticket.priority %>
                                                    </span>
                                                </td>
                                                <td><%= ticket.assigned_to || 'Unassigned' %></td>
                                                <td><%= new Date(ticket.created_at).toLocaleDateString() %></td>
                                                <td>
                                                    <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Tickets -->
                <div class="tab-pane fade" id="myTickets">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Ticket ID</th>
                                            <th>Subject</th>
                                            <th>Category</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% userTickets.forEach(ticket => { %>
                                            <tr>
                                                <td><code><%= ticket.ticket_id %></code></td>
                                                <td><%= ticket.subject %></td>
                                                <td><span class="badge bg-secondary"><%= ticket.category %></span></td>
                                                <td>
                                                    <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                        <%= ticket.status.replace('_', ' ') %>
                                                    </span>
                                                </td>
                                                <td><%= new Date(ticket.created_at).toLocaleDateString() %></td>
                                                <td>
                                                    <a href="/support/ticket/<%= ticket.ticket_id %>" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-eye"></i> View
                                                    </a>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Other tabs with similar structure but filtered data -->
                <div class="tab-pane fade" id="openTickets">
                    <!-- Similar table structure with filtered data -->
                </div>
                
                <div class="tab-pane fade" id="inProgressTickets">
                    <!-- Similar table structure with filtered data -->
                </div>
                
                <div class="tab-pane fade" id="closedTickets">
                    <!-- Similar table structure with filtered data -->
                </div>
            </div>
            
        <% } else { %>
            <!-- Regular User View -->
            <div class="row">
                <div class="col-md-8">
                    <h1>Support Center</h1>
                    <p class="lead">Need help? Create a support ticket and our team will assist you.</p>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Your Tickets</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTicketModal">
                                <i class="bi bi-plus-circle"></i> New Ticket
                            </button>
                        </div>
                        <div class="card-body">
                            <% if (userTickets.length === 0) { %>
                                <p class="text-muted text-center py-4">You haven't created any tickets yet.</p>
                            <% } else { %>
                                <div class="list-group">
                                    <% userTickets.forEach(ticket => { %>
                                        <a href="/support/ticket/<%= ticket.ticket_id %>" class="list-group-item list-group-item-action">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1"><%= ticket.subject %></h6>
                                                    <p class="mb-1 text-muted"><%= ticket.ticket_id %></p>
                                                    <small class="text-muted">Created <%= new Date(ticket.created_at).toLocaleDateString() %></small>
                                                </div>
                                                <span class="badge bg-<%= ticket.status === 'open' ? 'success' : ticket.status === 'in_progress' ? 'warning' : 'secondary' %>">
                                                    <%= ticket.status.replace('_', ' ') %>
                                                </span>
                                            </div>
                                        </a>
                                    <% }) %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5><i class="bi bi-info-circle"></i> How It Works</h5>
                            <ol>
                                <li>Create a ticket describing your issue</li>
                                <li>Our support team will review it</li>
                                <li>You'll receive a response within 24 hours</li>
                                <li>Continue the conversation in the ticket</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5><i class="bi bi-clock"></i> Response Times</h5>
                            <ul class="list-unstyled">
                                <li><span class="badge bg-danger">High Priority</span> 1-2 hours</li>
                                <li><span class="badge bg-primary">Normal</span> 12-24 hours</li>
                                <li><span class="badge bg-secondary">Low</span> 24-48 hours</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    <% } %>
</div>

<!-- Create Ticket Modal -->
<div class="modal fade" id="createTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Support Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTicketForm">
                    <div class="mb-3">
                        <label for="ticketCategory" class="form-label">Category</label>
                        <select class="form-select" id="ticketCategory" required>
                            <option value="">Select a category...</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="billing">Billing Issue</option>
                            <option value="technical">Technical Support</option>
                            <option value="general">General Question</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="ticketSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="ticketSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="ticketMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="ticketMessage" rows="5" required></textarea>
                        <div class="form-text">Please describe your issue in detail</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="support.createTicket()">Create Ticket</button>
            </div>
        </div>
    </div>
</div>

<script>
class SupportSystem {
    constructor() {
        this.currentTicket = '<%= typeof ticket !== "undefined" && ticket ? ticket.ticket_id : "" %>';
        this.isStaff = <%= typeof isStaff !== 'undefined' ? isStaff : false %>;
        this.init();
    }

    init() {
        if (this.currentTicket) {
            this.initTicketView();
        } else {
            this.initSupportDashboard();
        }
    }

    initTicketView() {
        const messageContainer = document.getElementById('messageContainer');
        if (messageContainer) {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        const replyForm = document.getElementById('replyForm');
        if (replyForm) {
            replyForm.addEventListener('submit', (e) => this.handleReply(e));
        }
    }

    initSupportDashboard() {
        // Tab event listeners if needed
    }

    async handleReply(e) {
        e.preventDefault();
        
        const messageInput = document.getElementById('replyMessage');
        const message = messageInput.value.trim();
        if (!message) return;
        
        messageInput.disabled = true;
        e.target.querySelector('button').disabled = true;
        
        try {
            const response = await fetch(`/support/ticket/${this.currentTicket}/message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            } else {
                this.showAlert('danger', 'Error sending message: ' + (result.error || 'Unknown error'));
                messageInput.disabled = false;
                e.target.querySelector('button').disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('danger', 'Error sending message');
            messageInput.disabled = false;
            e.target.querySelector('button').disabled = false;
        }
    }

    async createTicket() {
        const category = document.getElementById('ticketCategory').value;
        const subject = document.getElementById('ticketSubject').value;
        const message = document.getElementById('ticketMessage').value;
        
        if (!category || !subject || !message) {
            this.showAlert('warning', 'Please fill in all fields');
            return;
        }
        
        try {
            const response = await fetch('/support/ticket/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category, subject, message })
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.location.href = '/support/ticket/' + result.ticketId;
            } else {
                this.showAlert('danger', 'Error creating ticket: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('danger', 'Error creating ticket');
        }
    }

    async updateStatus(status) {
        if (!this.isStaff && status === 'closed') {
            if (!confirm('Are you sure you want to close this ticket?')) return;
        }
        
        try {
            const response = await fetch(`/support/ticket/${this.currentTicket}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            } else {
                this.showAlert('danger', 'Error updating status: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('danger', 'Error updating status');
        }
    }

    async updatePriority(priority) {
        try {
            const response = await fetch(`/support/ticket/${this.currentTicket}/priority`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ priority })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showAlert('success', 'Priority updated successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                this.showAlert('danger', 'Error updating priority');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('danger', 'Error updating priority');
        }
    }

    async assignTicket(staffId) {
        try {
            const response = await fetch(`/support/ticket/${this.currentTicket}/assign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ staffId })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showAlert('success', 'Ticket assigned successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                this.showAlert('danger', 'Error assigning ticket');
            }
        } catch (error) {
            console.error('Error:', error);
            this.showAlert('danger', 'Error assigning ticket');
        }
    }

    showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
        alert.style.zIndex = '9999';
        alert.innerHTML = message;
        document.body.appendChild(alert);
        
        setTimeout(() => alert.remove(), 3000);
    }
}

// Initialize support system
const support = new SupportSystem();
</script>

<%- include('partials/footer') %>